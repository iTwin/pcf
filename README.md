[![Build Status](https://dev.azure.com/bentleycs/iModelTechnologies/_apis/build/status/iTwin.pcf?branchName=main)](https://dev.azure.com/bentleycs/iModelTechnologies/_build/latest?definitionId=5431&branchName=main)

Table of Contents
=======================

* [About](#about)
* [Getting Started](#getting-started)
* [Constructs](#constructs)
* [Development](#development)
* [How to write a Loader?](#how-to-write-a-loader)
* [Programmatically Generate Construct Instances](#programmatically-generate-construct-instances)
* [Install from source](#install-from-source)
* [In-depth Concepts](https://github.com/iTwin/pcf/wiki)

# About

Parametric Connector Framework (PCF) is the most advanced and intelligent tool for synchronizing external data with digital twins. PCF allows you to **define** your iModel as code then it takes care of the steps to synchronize it with external data to your desired state. With PCF, you have the full control over how you would like your data mapped to an iModel with minimal programming effort.

# Getting Started


```bash
# make sure your npm version is < 7.0.0
npm --version 
# run this command if you npm version is > 7.0.0
npm install -g npm@6.x

```

```bash

# 1. install global pcf command line utility
npm install -g @itwin/pcf-cli

# 2. initialize a connector template with a name. This command will create a project directory named "output"
pcf init <name of your connector> 
cd output

# 3. install the latest version of pcf core in your project
npm install @itwin/pcf

# 4. add application specific info in ./src/App.ts

# 5. execute your connector (compilation is included in this command)
npm run start

```

Currently, all the documentations and API references of this project are embedded in source files. Use your IDE/language server to look them up through go-to-definitions.

# Constructs

You will be using a set of constructs to build your connector.

| Name             | Definition                                                                                                   |
|------------------|--------------------------------------------------------------------------------------------------------------|
|**IR Model** &nbsp;&nbsp; | An intermediate representation virtual Entity-Relationship store generated by a **Loader** from your source data. <br> It is made of three classes: <br> **IR Entity** = External Class (e.g. database table). <br> **IR Relationship** = External Relationship Class (e.g. database link table or table that contains foreign key relationships). <br> **IR Instance** = the instances of an External Class (e.g. a row in database table) |
|**Loader**        | An accessor to a data source. Responsible for converting the source data into an IR Model. You may use an existing Loader or write your own. |
|**DMO**           | A DMO (Dynamic Mapping Object) defines the mappings between IR Model and iModel. |
|**Node**          | A Node corresponds to an EC Entity and some Nodes use DMO to populate multiple EC Instances. An iModel is synchronized based on user-defined Nodes. |


# Development

* Dependencies
    * You should not install any iTwin.js related dependencies aside from schema npm packages (@bentley/<schema name>-schema). If the same package is installed in two different versions by your connector and PCF, you may encounter hidden bugs.
    * Most existing domain schema packages can be found [here](https://www.npmjs.com/search?q=%40bentley%20schema%20).
* Node
    * The following entity class cannot be deleted from your iModel once created: Subject, Partition, Model.
    * Modifying the key of SubjectNode or ModelNode would cause new Subject, Model, and Partition to be created.
    * Parent-child Modeling is not supported yet. Only the top models and their elements are synchronized.
    * Great articles to learn some background information to help you organize Nodes
        * [iModel information hierarchy](https://www.itwinjs.org/bis/intro/information-hierarchy/)
        * [Fabric of the universe](https://www.itwinjs.org/bis/intro/fabric-of-the-universe/)
* Dynamic Schema
    * Only Primitive EC Properties can be added to DMO.ecElement/ecRelationship. They cannot be deleted once added.
* Loaders
    * Each Loader is recorded as a [Repository Link](https://www.itwinjs.org/reference/imodeljs-backend/elements/repositorylink) in your iModel.
    * Currently supported loaders can be found in [here](https://github.com/iTwin/pcf/tree/main/core/src/loaders). 

## How to write a Loader?

You may need to write your own Loader if you need to customize the way of accessing source data.
 
Before deciding to write one yourself, check out the existing ones or consider extending them. All loaders must extend the base class [Loader](https://github.com/itwin/pcf/blob/main/core/src/loaders/Loader.ts).

## Programmatically Generate Construct Instances

Since your connector is represented purely by objects (DMOs & Nodes), you can programmatically generate them based on external source data. See a sample below.

```typescript

// inside XYZConnector.ts where Nodes are defined:

import * as pcf from "@itwin/pcf";

export class XYZConnector extends pcf.PConnector {
  public async form() {

    ...

    const model = new pcf.ModelNode(...);
   
    const data: any[] = // Define any logics to get the data necessary to generate PCF construct instances
 
    for (const item of data) {
      // use data stored in "item" to populate the fields of DMO and/or Node
      const dmo: pcf.ElementDMO = ...
      const node = new pcf.ElementNode(this, { ..., model, dmo } );
    }
  }
}

```


# Install from source

### pre-steps:
```console
# clone PCF repo
git clone https://github.com/iTwin/pcf.git

# install PCF core dependencies
cd core
npm ci

# build
npm run build
```

### Option 1: try PCF locally with your connector:
```console
# create global symlink
npm link

# use @itwin/pcf package locally without installing it
cd <your connector project dir>
npm link @itwin/pcf
```

### Option 2: run PCF unit tests:
```console
npm run test
```

# Inspired by

- [Compiler Design](https://en.wikipedia.org/wiki/Compiler)
- [Object-Relational Mapping](https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping)
- [AWS CDK](https://github.com/aws/aws-cdk)
- [Terraform](https://github.com/hashicorp/terraform)
